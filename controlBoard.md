## MIDI Control Board & Drum Hardware

The MIDI control board for SoleBot consist of an Arduino Nano (or Uno, even a bare 328p chip if you know how to handle the bare beast) and 11 dual MOSFET DC power switch boards as solenoid drivers. The next version will also have MIDI in and through components. Here is the basic circuit diagram showing a single module on pin 9, which is the rack tom, as per pins.h definition.

![Control Board Circuit (only one driver circuit shown)](https://github.com/crunchysteve/SoleBot/blob/main/images/CircuitDiagram.png)

The current Fritzing project and its exported Gerber file are designed to have an actual Arduino Nano and 11 dual MOSFET modules either hardwired or socketed for prototyping. I've nicknamed the control board the "MarkMothersboard" because the pun tickles me and I'm a near lifelong Devo fan. I *will* dine out on this pun.

The plan is to eventually design a board with MIDI interface, 328P chip and MOSFET drivers, in a custom layout, as descrete components. For my current, early prototype design, I'll hardwire a standard MIDI shield as my interface to my MIDI system as an external board. I have a large, plastic, electrical junction box for a housing that will take my 24v supply (stripped of its housing), supply fan, 5v buck converter, MIDI shield and custom control board, as well as leaving room outside for some pluggable terminal blocks, as shown below...

[![Jaycar pluggable terminal block)](https://github.com/crunchysteve/SoleBot/blob/main/images/HM3202_plug-socket-12-way-screw-terminal-strip_82612.png)](https://www.jaycar.com.au/plug-socket-12-way-screw-terminal-strip/p/HM3202)

This kind of terminal block can handle 10A per carrier, more than enough for each solenoid, as the smaller 10N solenoids draw short pulses of 4A, when fed with a 24v output from the PSU, and the 60N solenoids rely on turns to generate their magnetic force from 720mA at 24 volts for their maximum 50% duty cycle at this voltage. The other advantage of this connection system is that the solenoid side (with the pins) can be cut into pairs for drive and ground, while the driver side (sockets) can be left intact and wired drive, ground, drive, ground, etc, making it easy to connect/disconnect the drum beaters from the control module. This terminal block system will be mounter on the rear of the controller box.

## How the Controller Works

[The basic Arduino C code](https://github.com/crunchysteve/SoleBot/tree/main/code/midiSolebot/) reads incoming MIDI signals from the interface (the external shield used as a MIDI board) and routes the relevent note data to available drums and percussion, detecting the note number for the available drums nad its associated velocity (how hard to hit the drum), sending this to the appropriate output as an analogWrite() for drums and cymbals, a digitalWrite() for 2 state percussion (on or off), like the hi-hat lfters and as either a tone(pin,1000) or digitalWrite() (off, half on or on) for pseudo analog control of digital channels. The latter is effectively off, 50% duty cycle and 100% duty cycle for the duration of an output's trigger pulse, because a pulse of tone, the width of a drum trigger output is half the power of simply turning that pin on with a digital write for full duty cycle to the pin for the duration of the trigger pulse.

These "pseudo-analog" outputs are useful for giving some limited dynamics to things like a woodblock or cross stick count-in, triangles, crash cymbal and rim shots, etc. Eventually, this will also allow using an analog input, or two, as a digital output (which Arduino and compatible generally allow) in either digital or pseudo-analog mode bringing the system up to 5 piece drumming with mixed percussion. An extra 6 channels of drive for those who want it, still leaving analog input 4 and 5 for I2C peripherals.

[![Driver module)](https://github.com/crunchysteve/SoleBot/blob/main/images/sny00251.jpg)](https://core-electronics.com.au/mosfet-power-switch-module.html)

The MOSFET control boards are simply fast switches that respond to 5v digital signal inputs, from Arduino outputs, by switching switching 24v supply to operate the solenoids. The useful upper frequency limits of the solenoids will determine the tone() command pitch, or digital pulse length, on the 3 state and 2 state outputs.

As well as reading incoming MIDI notes and velocities, some limited randomisations of parameters in timing and velocity could be introduced, to create a less perfect, clockwork, either in the form of swing on drum machines or DAWs that have it, or via 2 controls on the drum robotics. Signal processing and mechanical latencies in the firmware and hardware may naturally introduce a little "swing," too. I call these inherent latencies, "microlatencies," as they're likely to be well below the maximum 20ms delay needed to make a beat feel like it's dragging, even on fours at 300BPM, the theoretical upper tempo limit the system is designed for. In reality, fours on 285BPM comes very close to exceeding a 50% duty cycle on the 12v rated solenoids, making 24v drive potentially able to burn them out.

## Mechanical Hardware

The control board isn't much use if there's no way to mount the solenoids on the drums. I'm not a drummer, I'm a guitarist/bassist, so forgive my admission that I've only just learned this particular type of hardware is called a "hoop clamp." Having access to a pair of exceedingly unreliable, older Ender 3 3D printers, progress on these solenoid beater specific [hoop clamps](https://github.com/crunchysteve/SoleBot/tree/main/scadFiles) has been slow. 

However, In looking at what existing hardware is available for adaptation to mounting the beater solenoids, it seems my DP Percussion "toy" 4 piece "kiddy" kit is more standard than I'd realised. There are numerous "hoop clamp" systems available for mounting things like (*MORE!*) cowbells, woodblocks or tambourines and the pictures show very similar hoop systems across most brands. I probably only need to "loosen" my design's dimensions a little to cover most kits and pickup one of these hoop clamps to reverse engineer a more universal dimensions set.

The current CAD files are OpenSCAD format, a mathematical CAD language that's more like programming than designing. I'm learning Ondsel (a commecial fork of FreeCAD) in order to import and export files in more common formats, readable in more common CAD platforms like OnShape and AutoCAD, but I still prefer to "code" my initial designs in OpenSCAD. It's just how I roll.

The trickiest hardware to accommodate is the hi-hat mechanism. A human drummer keeps light foot pressure on the hi-hat pedal for that rattly, "sizzle" of half open, lifts their foot to open the cymbal completely, allowing it to ring free, and pushes the pedal "to the floor" to close the cymbal for that "*tick* tick tick tick" sound. So, that classic disco hihat sound, "*tick* tick tiss-sup tick," is done with a stick for each sound starting with a "T" but the "tiss-up" is done by lifting the hat pedal, then pushing it. That's 3 states, and a solenoid only has 2.

I could use a servo, but fast, high thrust servos are expensive and noisy. This would add a "*WHIR WHIR*" sound just slightly ahead of the "tiss-up" in a disco beat, or other similar hi-hat expression and that whirring noise is undesirable. Noise isn't a problem for a CNC tool changer, it's a major problem for an amplified acoustic instrument like a drum kit.

My plan to convert a 2 state actuator to a 3 state system is to double articulate the "hats", with both upper and lower cymbals being lifted by the 60N solenoids, the lower cymbal lifted to close, the upper cymbal lifted to open, the cymbals at rest just touching in the half-open position. The upper cymbal is locked to the riser shaft, the lower one runs free, with the clutch pushed up by a second, short riser from the second solenoid. I built a large frame out of scrap aluminium to do this, but that may be an awkward fixture to mount on conventional drum hardware, so I'm going back to a double clutch using my existing hi-hat stand with the pedal removed and a few brackets added.

Finally, the kick drum has a riser or stanchion for its beater solenoid, kind of like a kick drum pedal, only without the pedal. Having discovered that kick drum hoop clamps are also a thing, I may change the design to use that kind of system. I'm also thinking the kick drum "needs" one of the heavy duty 60N solenoids and a heavier beater than the current cylindical beater to impart more energy to the largest skin in the kit. The 10N beater hits OK, but the snare swamps it out in regard to audio levels in-room.

As always, this is an open project. If you can see a better way to do any part of this, post a feature request in the discussions, raise an issue, or offer your code with a pull request.